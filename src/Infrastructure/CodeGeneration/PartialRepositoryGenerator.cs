using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Reflection;
using System.Text;
using System.Threading.Tasks;

namespace NextAdmin.Infrastructure.CodeGeneration
{
    /// <summary>
    /// Partial ä»“å‚¨ä»£ç ç”Ÿæˆå™¨
    /// æ ¹æ®ä»“å‚¨æ¥å£è‡ªåŠ¨ç”ŸæˆåŸºç¡€å®ç°ä»£ç 
    /// </summary>
    public class PartialRepositoryGenerator
    {
        private readonly string _outputDirectory;
        private readonly Assembly[] _assemblies;

        public PartialRepositoryGenerator(string outputDirectory, params Assembly[] assemblies)
        {
            _outputDirectory = outputDirectory ?? throw new ArgumentNullException(nameof(outputDirectory));
            _assemblies = assemblies ?? Array.Empty<Assembly>();
        }

        /// <summary>
        /// ç”Ÿæˆæ‰€æœ‰ä»“å‚¨çš„ partial å®ç°
        /// </summary>
        public async Task GenerateAllRepositoriesAsync()
        {
            Console.WriteLine("=== Partial ä»“å‚¨ä»£ç ç”Ÿæˆå™¨ ===");
            Console.WriteLine($"è¾“å‡ºç›®å½•: {_outputDirectory}");
            Console.WriteLine();

            if (!Directory.Exists(_outputDirectory))
            {
                Directory.CreateDirectory(_outputDirectory);
                Console.WriteLine($"âœ… å·²åˆ›å»ºè¾“å‡ºç›®å½•");
            }

            // æŸ¥æ‰¾æ‰€æœ‰ä»“å‚¨æ¥å£
            var repositoryInterfaces = FindRepositoryInterfaces();
            Console.WriteLine($"ğŸ“‹ å‘ç° {repositoryInterfaces.Count} ä¸ªä»“å‚¨æ¥å£");
            Console.WriteLine();

            foreach (var interfaceType in repositoryInterfaces)
            {
                await GeneratePartialRepositoryAsync(interfaceType);
            }

            Console.WriteLine();
            Console.WriteLine("ğŸ‰ æ‰€æœ‰ä»“å‚¨ä»£ç ç”Ÿæˆå®Œæˆï¼");
        }

        /// <summary>
        /// ç”Ÿæˆå•ä¸ªä»“å‚¨çš„ partial å®ç°
        /// </summary>
        public async Task GeneratePartialRepositoryAsync(Type interfaceType)
        {
            if (interfaceType == null || !interfaceType.IsInterface)
            {
                throw new ArgumentException("å¿…é¡»æ˜¯æ¥å£ç±»å‹", nameof(interfaceType));
            }

            var entityName = GetEntityNameFromInterface(interfaceType);
            var fileName = $"{entityName}Repository.Generated.cs";
            var filePath = Path.Combine(_outputDirectory, fileName);

            Console.WriteLine($"ğŸ”§ ç”Ÿæˆ: {fileName}");

            var code = GenerateRepositoryCode(interfaceType, entityName);

            await File.WriteAllTextAsync(filePath, code, Encoding.UTF8);

            Console.WriteLine($"   âœ… å·²ç”Ÿæˆ: {filePath}");
        }

        /// <summary>
        /// æŸ¥æ‰¾æ‰€æœ‰ä»“å‚¨æ¥å£
        /// </summary>
        private List<Type> FindRepositoryInterfaces()
        {
            var interfaces = new List<Type>();

            foreach (var assembly in _assemblies)
            {
                try
                {
                    var types = assembly.GetTypes()
                        .Where(t => t.IsInterface &&
                                    t.Name.StartsWith("I") &&
                                    t.Name.EndsWith("Repository") &&
                                    t.Name != "IBaseRepository")
                        .ToList();

                    interfaces.AddRange(types);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"âš ï¸  è­¦å‘Š: æ— æ³•åŠ è½½ç¨‹åºé›† {assembly.FullName}: {ex.Message}");
                }
            }

            return interfaces;
        }

        /// <summary>
        /// ä»æ¥å£åç§°æå–å®ä½“åç§°
        /// </summary>
        private string GetEntityNameFromInterface(Type interfaceType)
        {
            var name = interfaceType.Name;
            if (name.StartsWith("I") && name.EndsWith("Repository"))
            {
                return name.Substring(1, name.Length - 11); // ç§»é™¤ "I" å’Œ "Repository"
            }
            return name;
        }

        /// <summary>
        /// ç”Ÿæˆä»“å‚¨ä»£ç 
        /// </summary>
        private string GenerateRepositoryCode(Type interfaceType, string entityName)
        {
            var sb = new StringBuilder();

            // æ–‡ä»¶å¤´æ³¨é‡Š
            sb.AppendLine("// <auto-generated>");
            sb.AppendLine($"// æ­¤æ–‡ä»¶ç”± PartialRepositoryGenerator è‡ªåŠ¨ç”Ÿæˆ");
            sb.AppendLine($"// ç”Ÿæˆæ—¶é—´: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            sb.AppendLine("// è­¦å‘Š: è¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹æ­¤æ–‡ä»¶ï¼Œæ‚¨çš„æ›´æ”¹å°†åœ¨ä¸‹æ¬¡ç”Ÿæˆæ—¶ä¸¢å¤±");
            sb.AppendLine("// </auto-generated>");
            sb.AppendLine();

            // Using å£°æ˜
            var usings = GetRequiredUsings(interfaceType);
            foreach (var usingNamespace in usings.OrderBy(u => u))
            {
                sb.AppendLine($"using {usingNamespace};");
            }
            sb.AppendLine();

            // å‘½åç©ºé—´
            sb.AppendLine($"namespace {interfaceType.Namespace?.Replace(".Interfaces.Repositories", ".Repositories") ?? "NextAdmin.Infrastructure.Repositories"}");
            sb.AppendLine("{");

            // ç±»å£°æ˜
            sb.AppendLine("    /// <summary>");
            sb.AppendLine($"    /// {entityName} ä»“å‚¨è‡ªåŠ¨ç”Ÿæˆçš„å®ç°");
            sb.AppendLine("    /// </summary>");
            sb.AppendLine($"    public partial class {entityName}Repository");
            sb.AppendLine("    {");

            // ç”Ÿæˆæ–¹æ³•å®ç°
            var methods = GetCustomMethods(interfaceType);
            var isFirst = true;

            foreach (var method in methods)
            {
                if (!isFirst)
                {
                    sb.AppendLine();
                }
                isFirst = false;

                GenerateMethodImplementation(sb, method, entityName);
            }

            sb.AppendLine("    }");
            sb.AppendLine("}");

            return sb.ToString();
        }

        /// <summary>
        /// è·å–æ‰€éœ€çš„ using å£°æ˜
        /// </summary>
        private HashSet<string> GetRequiredUsings(Type interfaceType)
        {
            var usings = new HashSet<string>
            {
                "System",
                "System.Collections.Generic",
                "System.Linq",
                "System.Threading.Tasks",
                "MongoDB.Driver",
                "MongoDB.Bson"
            };

            // æ·»åŠ æ¥å£æ‰€åœ¨å‘½åç©ºé—´
            if (!string.IsNullOrEmpty(interfaceType.Namespace))
            {
                usings.Add(interfaceType.Namespace);
            }

            // åˆ†ææ–¹æ³•å‚æ•°å’Œè¿”å›å€¼ç±»å‹
            var methods = interfaceType.GetMethods();
            foreach (var method in methods)
            {
                // è¿”å›ç±»å‹
                if (!string.IsNullOrEmpty(method.ReturnType.Namespace))
                {
                    usings.Add(method.ReturnType.Namespace);
                }

                // å‚æ•°ç±»å‹
                foreach (var parameter in method.GetParameters())
                {
                    if (!string.IsNullOrEmpty(parameter.ParameterType.Namespace))
                    {
                        usings.Add(parameter.ParameterType.Namespace);
                    }
                }
            }

            return usings;
        }

        /// <summary>
        /// è·å–æ¥å£ä¸­çš„è‡ªå®šä¹‰æ–¹æ³•ï¼ˆæ’é™¤ IBaseRepository çš„æ–¹æ³•ï¼‰
        /// </summary>
        private List<MethodInfo> GetCustomMethods(Type interfaceType)
        {
            var allMethods = interfaceType.GetMethods();
            
            // æ’é™¤ IBaseRepository<T> çš„æ ‡å‡†æ–¹æ³•
            var standardMethodNames = new HashSet<string>
            {
                "GetByIdAsync", "GetAllAsync", "AddAsync", "UpdateAsync", 
                "DeleteAsync", "ExistsAsync", "CountAsync", "GetPagedAsync",
                "BulkAddAsync", "BulkUpdateAsync", "BulkDeleteAsync"
            };

            return allMethods
                .Where(m => !standardMethodNames.Contains(m.Name))
                .ToList();
        }

        /// <summary>
        /// ç”Ÿæˆæ–¹æ³•å®ç°
        /// </summary>
        private void GenerateMethodImplementation(StringBuilder sb, MethodInfo method, string entityName)
        {
            // XML æ³¨é‡Š
            sb.AppendLine("        /// <summary>");
            sb.AppendLine($"        /// {method.Name} çš„è‡ªåŠ¨ç”Ÿæˆå®ç°");
            sb.AppendLine("        /// </summary>");

            // æ–¹æ³•ç­¾å
            var parameters = method.GetParameters();
            var paramList = string.Join(", ", parameters.Select(p => $"{GetFriendlyTypeName(p.ParameterType)} {p.Name}"));
            var returnType = GetFriendlyTypeName(method.ReturnType);

            sb.AppendLine($"        public {returnType} {method.Name}({paramList})");
            sb.AppendLine("        {");

            // ç”Ÿæˆæ–¹æ³•ä½“
            GenerateMethodBody(sb, method, entityName);

            sb.AppendLine("        }");
        }

        /// <summary>
        /// ç”Ÿæˆæ–¹æ³•ä½“
        /// </summary>
        private void GenerateMethodBody(StringBuilder sb, MethodInfo method, string entityName)
        {
            var returnType = method.ReturnType;
            var isAsync = returnType.Name.Contains("Task");

            // æ ¹æ®æ–¹æ³•åæ¨æ–­å®ç°é€»è¾‘
            var methodName = method.Name;

            if (methodName.StartsWith("GetBy") && methodName.EndsWith("Async"))
            {
                GenerateGetByMethodBody(sb, method, entityName);
            }
            else if (methodName.StartsWith("Search") && methodName.EndsWith("Async"))
            {
                GenerateSearchMethodBody(sb, method, entityName);
            }
            else if (methodName.StartsWith("Exists") && methodName.EndsWith("Async"))
            {
                GenerateExistsMethodBody(sb, method, entityName);
            }
            else if (methodName.StartsWith("GetCount") || methodName.Contains("Count"))
            {
                GenerateCountMethodBody(sb, method, entityName);
            }
            else if (methodName.StartsWith("BulkInsert") || methodName.StartsWith("Bulk"))
            {
                GenerateBulkMethodBody(sb, method, entityName);
            }
            else
            {
                // é»˜è®¤å®ç°ï¼šæŠ›å‡ºæœªå®ç°å¼‚å¸¸
                sb.AppendLine($"            throw new NotImplementedException(\"æ–¹æ³• {method.Name} éœ€è¦åœ¨ {entityName}Repository çš„å¦ä¸€ä¸ª partial éƒ¨åˆ†ä¸­å®ç°ã€‚\");");
            }
        }

        /// <summary>
        /// ç”Ÿæˆ GetBy æ–¹æ³•ä½“
        /// </summary>
        private void GenerateGetByMethodBody(StringBuilder sb, MethodInfo method, string entityName)
        {
            var parameters = method.GetParameters();
            var returnType = method.ReturnType;
            var isList = returnType.IsGenericType && returnType.GetGenericTypeDefinition() == typeof(Task<>)
                && returnType.GetGenericArguments()[0].IsGenericType
                && returnType.GetGenericArguments()[0].GetGenericTypeDefinition() == typeof(List<>);

            sb.AppendLine("            var filterBuilder = Builders<" + entityName + ">.Filter;");
            sb.AppendLine("            var filters = new List<FilterDefinition<" + entityName + ">>");
            sb.AppendLine("            {");
            sb.AppendLine("                filterBuilder.Eq(x => x.IsDeleted, false)");
            sb.AppendLine("            };");
            sb.AppendLine();

            // ä¸ºæ¯ä¸ªå‚æ•°æ·»åŠ è¿‡æ»¤æ¡ä»¶
            foreach (var param in parameters)
            {
                var paramName = param.Name;
                var propertyName = char.ToUpper(paramName![0]) + paramName.Substring(1);

                if (param.ParameterType.Name.Contains("Nullable") || param.ParameterType.IsClass)
                {
                    sb.AppendLine($"            if ({paramName} != null)");
                    sb.AppendLine("            {");
                    sb.AppendLine($"                filters.Add(filterBuilder.Eq(x => x.{propertyName}, {paramName}));");
                    sb.AppendLine("            }");
                }
                else
                {
                    sb.AppendLine($"            filters.Add(filterBuilder.Eq(x => x.{propertyName}, {paramName}));");
                }
            }

            sb.AppendLine();
            sb.AppendLine("            var filter = filterBuilder.And(filters);");
            sb.AppendLine();

            if (isList)
            {
                sb.AppendLine("            return await Collection.Find(filter)");
                sb.AppendLine("                .SortBy(x => x.CreateTime)");
                sb.AppendLine("                .ToListAsync();");
            }
            else
            {
                sb.AppendLine("            return await Collection.Find(filter).FirstOrDefaultAsync();");
            }
        }

        /// <summary>
        /// ç”Ÿæˆ Search æ–¹æ³•ä½“
        /// </summary>
        private void GenerateSearchMethodBody(StringBuilder sb, MethodInfo method, string entityName)
        {
            sb.AppendLine("            // TODO: å®ç°æœç´¢é€»è¾‘");
            sb.AppendLine("            var filter = Builders<" + entityName + ">.Filter.Eq(x => x.IsDeleted, false);");
            sb.AppendLine("            return await Collection.Find(filter).ToListAsync();");
        }

        /// <summary>
        /// ç”Ÿæˆ Exists æ–¹æ³•ä½“
        /// </summary>
        private void GenerateExistsMethodBody(StringBuilder sb, MethodInfo method, string entityName)
        {
            sb.AppendLine("            var filter = Builders<" + entityName + ">.Filter.Eq(x => x.IsDeleted, false);");
            sb.AppendLine("            var count = await Collection.CountDocumentsAsync(filter);");
            sb.AppendLine("            return count > 0;");
        }

        /// <summary>
        /// ç”Ÿæˆ Count æ–¹æ³•ä½“
        /// </summary>
        private void GenerateCountMethodBody(StringBuilder sb, MethodInfo method, string entityName)
        {
            sb.AppendLine("            var filter = Builders<" + entityName + ">.Filter.Eq(x => x.IsDeleted, false);");
            sb.AppendLine("            return await Collection.CountDocumentsAsync(filter);");
        }

        /// <summary>
        /// ç”Ÿæˆ Bulk æ–¹æ³•ä½“
        /// </summary>
        private void GenerateBulkMethodBody(StringBuilder sb, MethodInfo method, string entityName)
        {
            sb.AppendLine("            // TODO: å®ç°æ‰¹é‡æ“ä½œé€»è¾‘");
            sb.AppendLine($"            throw new NotImplementedException(\"æ–¹æ³• {method.Name} éœ€è¦åœ¨ {entityName}Repository çš„å¦ä¸€ä¸ª partial éƒ¨åˆ†ä¸­å®ç°ã€‚\");");
        }

        /// <summary>
        /// è·å–å‹å¥½çš„ç±»å‹åç§°
        /// </summary>
        private string GetFriendlyTypeName(Type type)
        {
            if (!type.IsGenericType)
            {
                return type.Name switch
                {
                    "Void" => "void",
                    "String" => "string",
                    "Int32" => "int",
                    "Int64" => "long",
                    "Boolean" => "bool",
                    "Double" => "double",
                    "Decimal" => "decimal",
                    _ => type.Name
                };
            }

            var genericTypeName = type.Name.Split('`')[0];
            var genericArgs = string.Join(", ", type.GetGenericArguments().Select(GetFriendlyTypeName));

            return $"{genericTypeName}<{genericArgs}>";
        }
    }
}
